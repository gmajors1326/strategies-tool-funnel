// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Plan {
  FREE
  DM_ENGINE
  THE_STRATEGY
  ALL_ACCESS
}

model User {
  id                        String   @id @default(cuid())
  name                      String?
  email                     String   @unique
  emailVerifiedAt           DateTime?
  plan                      Plan     @default(FREE)
  freeVerifiedRunsRemaining Int      @default(3)
  activeOrgId               String?
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  profile                Profile?
  toolRuns               ToolRun[]
  planItems              PlanItem[]
  supportTickets         SupportTicket[]
  entitlements           PlanEntitlement?
  otps                   Otp[]
  aiUsageLogs            AiUsageLog[]
  notifications          Notification[]
  notificationPreference NotificationPreference?
  orgMemberships         OrganizationMember[]
  activeOrg              Organization? @relation("ActiveOrg", fields: [activeOrgId], references: [id])

  @@index([email])
  @@index([plan])
  @@index([activeOrgId])
}

model Profile {
  id               String   @id @default(cuid())
  userId           String   @unique
  followerRange    String?
  postingFrequency String?
  engagementTime   String?
  primaryGoal      String?
  biggestFriction  String?
  niche            String?
  sellingType      String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ToolRun {
  id         String   @id @default(cuid())
  userId     String?
  toolKey    String
  inputsJson Json
  outputsJson Json
  saved      Boolean  @default(false)
  expiresAt  DateTime?
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([toolKey])
  @@index([createdAt])
  @@index([saved])
  @@index([expiresAt])
}

model PlanItem {
  id        String   @id @default(uuid())
  userId    String
  toolId    String
  title     String
  inputs    Json
  outputs   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([toolId])
  @@index([createdAt])
}

model Otp {
  id        String   @id @default(cuid())
  email     String
  codeHash  String
  expiresAt DateTime
  attempts  Int      @default(0)
  createdAt DateTime @default(now())

  user User? @relation(fields: [email], references: [email], onDelete: Cascade)

  @@index([email])
  @@index([expiresAt])
}

model PlanEntitlement {
  id        String   @id @default(cuid())
  userId    String   @unique
  dmEngine  Boolean  @default(false)
  strategy  Boolean  @default(false)
  allAccess Boolean  @default(false)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model KnowledgeItem {
  id           String   @id @default(cuid())
  key          String   @unique
  category     String   // diagnostic | profile | engagement | dm | objections | conversion | guardrails | voice
  tags         String[] // scenario, tone, intent, warmth, platform
  content      String   @db.Text
  priority     Int      @default(0)
  planRequired String   @default("free") // free | dm_engine | the_strategy | all_access
  style        String   @default("both") // strategist | closer | both
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([category])
  @@index([planRequired])
  @@index([style])
  @@index([priority])
}

model PromptProfile {
  id           String   @id @default(cuid())
  name         String   @unique
  style        String   // strategist | closer
  dos          String   @db.Text
  donts        String   @db.Text
  bannedPhrases String[]
  toneNotes    String   @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([style])
}

model PromptRubric {
  id              String   @id @default(cuid())
  toolKey         String   @unique
  inputHints      String   @db.Text
  outputSchemaJson Json
  reasoningRules  String   @db.Text
  safetyRules     String   @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([toolKey])
}

model AiUsageLog {
  id           String   @id @default(cuid())
  userId       String?
  toolKey      String
  style        String? // strategist | closer
  tokensIn     Int?
  tokensOut    Int?
  costEstimate Float?
  createdAt    DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([toolKey])
  @@index([createdAt])
}

model WebhookDelivery {
  id           String   @id @default(cuid())
  eventId      String   @unique
  type         String
  customerId   String?
  status       String
  receivedAt   DateTime @default(now())
  processedAt  DateTime?
  errorMessage String?

  @@index([customerId])
  @@index([receivedAt])
  @@index([type])
  @@index([status])
}

model WebhookSecret {
  id         String   @id @default(cuid())
  customerId String
  secret     String
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  rotatedAt  DateTime?
  lastUsedAt DateTime?

  @@index([customerId])
  @@index([active])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  metadata  Json?
  readAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([readAt])
}

model NotificationPreference {
  id              String   @id @default(cuid())
  userId          String   @unique
  digestFrequency String   @default("weekly") // none | daily | weekly
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ToolFeedback {
  id        String   @id @default(uuid())
  userId    String
  toolId    String
  runId     String?

  rating    Int?
  thumbs    String?  // "up" | "down"
  tags      Json?
  comment   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([toolId])
  @@index([runId])
  @@index([userId, toolId, createdAt])
}

model ToolBonusRuns {
  id         String   @id @default(uuid())
  userId     String
  toolId     String?  // null => usable for any tool

  runsGranted Int
  runsUsed    Int      @default(0)

  reason     String?
  expiresAt  DateTime?
  grantedBy  String?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
  @@index([toolId])
  @@index([userId, toolId])
  @@index([userId, expiresAt])
}

model TokenLedger {
  id          String   @id @default(uuid())
  userId      String
  eventType   String
  tokensDelta Int
  toolId      String?
  runId       String?
  reason      String?
  createdAt   DateTime @default(now())

  @@index([userId, createdAt])
  @@index([userId, eventType, createdAt])
  @@index([runId])
}

model DailyUsage {
  id               String   @id @default(uuid())
  userId           String
  windowStart      DateTime
  windowEnd        DateTime
  aiTokensUsed     Int      @default(0)
  runsUsed         Int      @default(0)
  perToolRunsUsed  Json     @default("{}")
  resetsAt         DateTime
  updatedAt        DateTime @default(now())

  @@unique([userId, windowEnd])
  @@index([userId, windowEnd])
}

model Entitlement {
  id          String   @id @default(uuid())
  userId      String   @unique
  plan        String
  resetsAt    DateTime
  tokensCache Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

model StripeEvent {
  id        String   @id @default(uuid())
  eventId   String   @unique
  type      String
  createdAt DateTime @default(now())

  @@index([type])
  @@index([createdAt])
}

model Organization {
  id                    String   @id @default(uuid())
  name                  String
  slug                  String   @unique
  domain                String?
  plan                  String   @default("business") // business|enterprise
  stripeCustomerId      String?  @unique
  stripeSubscriptionId  String?  @unique
  seatsIncluded         Int      @default(1)
  seatsMax              Int      @default(5)
  walletMode            String   @default("per_seat") // per_seat|shared
  sharedTokensCache     Int?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  memberships OrganizationMember[]
  activeUsers User[] @relation("ActiveOrg")

  @@index([domain])
}

model OrganizationMember {
  id           String   @id @default(uuid())
  orgId        String
  userId       String
  role         String   @default("member") // owner|admin|member|viewer
  status       String   @default("active") // active|invited|disabled
  invitedEmail String?
  invitedBy    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id])
  user         User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
  @@index([orgId])
  @@index([userId])
  @@index([userId, role])
}

model OrganizationInvite {
  id         String   @id @default(uuid())
  orgId      String
  email      String
  role       String   @default("member")
  token      String   @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime @default(now())

  @@unique([orgId, email])
  @@index([orgId])
  @@index([email])
}

model AuditLog {
  id        String   @id @default(uuid())
  orgId     String?
  userId    String?
  action    String
  targetId  String?
  meta      Json?
  createdAt DateTime @default(now())

  @@index([orgId])
  @@index([userId])
  @@index([action])
  @@index([orgId, createdAt])
}

model ToolRunLog {
  id           String   @id @default(uuid())
  orgId        String?
  userId       String
  toolId       String
  runId        String   @unique
  meteringMode String
  tokensCharged Int     @default(0)
  status       String   // ok|locked|error
  lockCode     String?
  durationMs   Int?
  createdAt    DateTime @default(now())

  @@index([orgId])
  @@index([userId])
  @@index([toolId])
  @@index([userId, createdAt])
  @@index([orgId, createdAt])
}

model SupportTicket {
  id        String   @id @default(uuid())
  userId    String
  subject   String
  category  String
  status    String   @default("open") // open|pending|resolved|closed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages SupportMessage[]

  @@index([userId, createdAt])
  @@index([status])
}

model SupportMessage {
  id         String   @id @default(uuid())
  ticketId   String
  authorRole String   // user|admin|support
  authorId   String?
  message    String
  createdAt  DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId, createdAt])
  @@index([authorRole])
}
